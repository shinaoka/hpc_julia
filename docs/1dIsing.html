

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>1D Ising model &#8212; HPC exercise in Julia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/spanels-index--0afa1ebdab0bb23b98b56d34c23d9f57.css" />
    <link rel="stylesheet" type="text/css" href="../_static/spanels-variables--ffc7f74dcb1b9eecba2dbcbc22818714.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2D Ising model" href="2dIsing.html" />
    <link rel="prev" title="概要" href="mc.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">HPC exercise in Julia</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <p class="caption">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="preparation.html">
   Preparation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Classical Monte Carlo simulation
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="mc.html">
   概要
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   1D Ising model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2dIsing.html">
   2D Ising model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bzintegration.html">
   BZ integration
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/1dIsing.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/shinaoka/hpc_julia.git/master?urlpath=tree/docs/1dIsing.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/shinaoka/hpc_julia.git/blob/master/docs/1dIsing.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#first-simple-implementation">
   First simple implementation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-1">
     Exercise 1
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#complete-implementation-with-measurement">
   Complete implementation with measurement
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2">
     Exercise 2
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#type-stability-of-accumulator">
   Type stability of Accumulator
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="d-ising-model">
<h1>1D Ising model<a class="headerlink" href="#d-ising-model" title="Permalink to this headline">¶</a></h1>
<p>Let us consider the 1D Ising model defined by the Hamiltonian</p>
<div class="math notranslate nohighlight">
\[
\mathcal{H} = -\sum_i S_i S_{i+1}
\]</div>
<p>with periodic boundary conditions.</p>
<p>When we update the <span class="math notranslate nohighlight">\(i\)</span>-the spin (using the procedure described in the previous section),
the energy difference of the two states can be computed as <span class="math notranslate nohighlight">\(\Delta E = E_\uparrow - E_\downarrow = - 2h\)</span> with <span class="math notranslate nohighlight">\(O(1)\)</span> operations.
Here, <span class="math notranslate nohighlight">\(h = S_{i-1} + S_{i+1}\)</span> is the effective magnetic field acting on the <span class="math notranslate nohighlight">\(i\)</span>-th spin from the other spins (i.e., the nearest-neighbor spins).
Then, we take the state of <span class="math notranslate nohighlight">\(S_i=1\)</span> with a probability of <span class="math notranslate nohighlight">\(1/(1+\exp(\beta \Delta E ))=1/(1+\exp(-2h\beta))\)</span>.</p>
<p>The values of the exponential function are precomputed and stored in memory to avoid expensive reevaluation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@show</span> <span class="nb">VERSION</span>
<span class="k">using</span> <span class="n">BenchmarkTools</span><span class="p">,</span> <span class="n">Random</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>VERSION = v&quot;1.5.2&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="first-simple-implementation">
<h2>First simple implementation<a class="headerlink" href="#first-simple-implementation" title="Permalink to this headline">¶</a></h2>
<p>Let us look at the implementation shown below.
The function ising1d! attempts to update each spin niters times.
This function will be compiled when it’s called for the first time.
Thus, you must call it once before measuring its timings.
Or, you can simply use the macro &#64;benchmark in BenchmarkTools,
which calles the function multiple times automatically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">ising1d!</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">min_h</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">max_h</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">β</span><span class="o">*</span><span class="n">h</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span> <span class="kp">in</span> <span class="n">min_h</span><span class="o">:</span><span class="n">max_h</span><span class="p">]</span>
    <span class="c">#prob_f(h) = 1/(1+exp(-2*β*h))</span>
    <span class="k">for</span> <span class="n">iter</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">niters</span><span class="p">,</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ifelse</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ifelse</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c"># h = -2, 0, 2</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">sl</span> <span class="o">+</span> <span class="n">sr</span>
        <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">prob</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="n">min_h</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c">#s[i] = ifelse(rand(rng) &lt; prob_f(h), +1, -1)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">num_spins</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">rng</span> <span class="o">=</span> <span class="kt">MersenneTwister</span><span class="p">(</span><span class="mi">4649</span><span class="p">)</span>
<span class="n">s0</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="kt">Int8</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">num_spins</span><span class="p">)</span>
<span class="n">β</span> <span class="o">=</span> <span class="mf">10.0</span>
<span class="n">niters</span> <span class="o">=</span> <span class="mi">10</span><span class="o">^</span><span class="mi">3</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>

<span class="c"># Run once to compile the function</span>
<span class="n">ising1d!</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>

<span class="nd">@time</span> <span class="n">ising1d!</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
<span class="nd">@benchmark</span> <span class="n">ising1d!</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span> <span class="n">setup</span><span class="o">=</span><span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">s0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0.000437 seconds (
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 allocation: 128 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 
  memory estimate:  128 bytes
  allocs estimate:  1
  --------------
  minimum time:     432.958 μs (0.00% GC)
  median time:      444.190 μs (0.00% GC)
  mean time:        480.678 μs (0.00% GC)
  maximum time:     1.269 ms (0.00% GC)
  --------------
  samples:          10000
  evals/sample:     1
</pre></div>
</div>
</div>
</div>
<div class="section" id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this headline">¶</a></h3>
<p>Check how the performance is affected without precomuting the exponential function.</p>
</div>
</div>
<div class="section" id="complete-implementation-with-measurement">
<h2>Complete implementation with measurement<a class="headerlink" href="#complete-implementation-with-measurement" title="Permalink to this headline">¶</a></h2>
<p>Next, let us implement the measurement of observables such as magnetization and energy.
The magnetization and energy can be updated simultanously with the update of the spin configuration,
which costs only <span class="math notranslate nohighlight">\(O(1)\)</span> operations.
If you compute the magnetization or energy from scratch,
it would cost <span class="math notranslate nohighlight">\(O(N)\)</span> operations.</p>
<p>We explicity write the <span class="math notranslate nohighlight">\(S_i\)</span> dependence of the total energy as</p>
<div class="math notranslate nohighlight">
\[
E(S_i) = - h S_i + E_0,
\]</div>
<p>where <span class="math notranslate nohighlight">\(h = S_{i-1} + S_{i+1}\)</span> and <span class="math notranslate nohighlight">\(E_0\)</span> is a constant that does not depend on <span class="math notranslate nohighlight">\(S_i\)</span>.</p>
<p>SpinState is a struct for storing a spin state and the values of associcated observables.
The data stored in a SpinState must be consistent throughout a Monte Carlo simulation.
It’s not allowed to redefine a struct in the top-level scope.
Thus, the definition of the struc SpinState is wrapped in a module, to allow the redefinition of a struc.
This is convenient for doing trial and error.</p>
<p>We also define functions for computing the energy and magnetization,
which are used in many places.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Wrap everything with a module to allow redefition of type</span>
<span class="k">module</span> <span class="n">MC</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Composite type to represent a spin state</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">mutable</span> <span class="k">struct</span> <span class="n">SpinState</span>
    <span class="n">num_spins</span><span class="o">::</span><span class="kt">Int</span>
    <span class="n">s</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Int8</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">energy</span><span class="o">::</span><span class="kt">Int</span>
    <span class="n">tot_mag</span><span class="o">::</span><span class="kt">Int</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Energy</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">energy</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">sum</span><span class="p">((</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="n">ifelse</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="p">))</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Total magnetization</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="n">total_magnetization</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Constructor</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">SpinState</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">SpinState</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">copy</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">energy</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">total_magnetization</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">sanity_check</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
    <span class="n">ss</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Sanity check</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">sanity_check</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
    <span class="nd">@assert</span> <span class="n">energy</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">ss</span><span class="o">.</span><span class="n">energy</span>
    <span class="nd">@assert</span> <span class="n">total_magnetization</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">ss</span><span class="o">.</span><span class="n">tot_mag</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Take an object of SpinState as an input and update it in place.</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">update!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="n">min_h</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">max_h</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">s</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">num_spins</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">β</span><span class="o">*</span><span class="n">h</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span> <span class="kp">in</span> <span class="n">min_h</span><span class="o">:</span><span class="n">max_h</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">iter</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">niters</span><span class="p">,</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span>
        <span class="n">sl</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ifelse</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">ifelse</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c"># h = -2, 0, 2</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">sl</span> <span class="o">+</span> <span class="n">sr</span>
        <span class="n">si_old</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">rand</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">prob</span><span class="p">[</span><span class="n">h</span><span class="o">-</span><span class="n">min_h</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c"># Update observables with O(1) operations</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">energy</span> <span class="o">+=</span> <span class="p">(</span><span class="n">si_old</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">h</span>
        <span class="n">ss</span><span class="o">.</span><span class="n">tot_mag</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">si_old</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">end</span>
<span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<p>Let us perform a series of updates and check the consistency of the SpinState object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">ss</span> <span class="o">=</span> <span class="n">MC</span><span class="o">.</span><span class="n">SpinState</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="n">MC</span><span class="o">.</span><span class="n">update!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
<span class="n">MC</span><span class="o">.</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark</span> <span class="n">MC</span><span class="o">.</span><span class="n">update!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">niters</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 
  memory estimate:  128 bytes
  allocs estimate:  1
  --------------
  minimum time:     445.644 μs (0.00% GC)
  median time:      466.555 μs (0.00% GC)
  mean time:        506.253 μs (0.00% GC)
  maximum time:     1.317 ms (0.00% GC)
  --------------
  samples:          9872
  evals/sample:     1
</pre></div>
</div>
</div>
</div>
<p>We now measure these observables during a Monte Carlo simulation.
Hereafter, <span class="math notranslate nohighlight">\(\langle O \rangle_\mathrm{MC}\)</span> denotes a Monte Carlo average of an observable <span class="math notranslate nohighlight">\(O\)</span>.</p>
<p>Heat capacity/specific heat:</p>
<div class="math notranslate nohighlight">
\[
C = \frac{\langle E^2\rangle_\mathrm{MC} - \langle E\rangle_\mathrm{MC}^2}{T^2}
\]</div>
<p>Squared magnetization (<span class="math notranslate nohighlight">\(\langle M\rangle_\mathrm{MC} = 0\)</span> due to symmetries):</p>
<div class="math notranslate nohighlight">
\[
M_2 = \langle M^2\rangle_\mathrm{MC}
\]</div>
<p>Magnetic susceptibility:</p>
<div class="math notranslate nohighlight">
\[
\chi = \frac{\langle M^2\rangle_\mathrm{MC}}{T}
\]</div>
<p>As a prelude, we will create an “Accumulator” to easily store the results of multiple measurements of physical quantities.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">Meas</span>

<span class="k">struct</span> <span class="n">Accumulator</span>
    <span class="n">count</span><span class="o">::</span><span class="kt">Dict</span><span class="p">{</span><span class="n">String</span><span class="p">,</span><span class="kt">UInt64</span><span class="p">}</span>
    <span class="n">data</span><span class="o">::</span><span class="kt">Dict</span><span class="p">{</span><span class="n">String</span><span class="p">,</span><span class="kt">Any</span><span class="p">}</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Constructor</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">Accumulator</span><span class="p">()</span>
    <span class="n">Accumulator</span><span class="p">(</span><span class="kt">Dict</span><span class="p">{</span><span class="n">String</span><span class="p">,</span><span class="kt">UInt64</span><span class="p">}(),</span> <span class="kt">Dict</span><span class="p">{</span><span class="n">String</span><span class="p">,</span><span class="kt">Any</span><span class="p">}())</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Add a sample</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="o">::</span><span class="n">Accumulator</span><span class="p">,</span> <span class="n">name</span><span class="o">::</span><span class="n">String</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">haskey</span><span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="k">else</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">acc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Compuate mean</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="o">::</span><span class="n">Accumulator</span><span class="p">,</span> <span class="n">name</span><span class="o">::</span><span class="n">String</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">/</span><span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">end</span>


<span class="c"># Perform some tests</span>
<span class="k">let</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">Meas</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">()</span>
    <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs1&quot;</span><span class="p">,</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs1&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs2&quot;</span><span class="p">,</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs2&quot;</span><span class="p">,</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="nd">@assert</span> <span class="n">Meas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs1&quot;</span><span class="p">)</span> <span class="n">≈</span> <span class="n">fill</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nd">@assert</span> <span class="n">Meas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs2&quot;</span><span class="p">)</span> <span class="n">≈</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>We measure every niters_meas Monte Carlo steps.
Every spin is attemped to be updated once in a signle Monte Carlo step.
We skip the first ntherm measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">solve!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">nsweeps</span><span class="p">,</span> <span class="n">ntherm</span><span class="p">,</span> <span class="n">interval_meas</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mod</span><span class="p">(</span><span class="n">nsweeps</span><span class="p">,</span> <span class="n">interval_meas</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&quot;nsweeps cannot be divided by interval_meas!&quot;</span><span class="p">)</span>
    <span class="k">end</span>
    
    <span class="c"># Thermalization steps</span>
    <span class="n">MC</span><span class="o">.</span><span class="n">update!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">ntherm</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    
    <span class="c"># Measurement steps</span>
    <span class="k">for</span> <span class="n">imeas</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="p">(</span><span class="n">nsweeps÷interval_meas</span><span class="p">)</span>
        <span class="n">MC</span><span class="o">.</span><span class="n">update!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">interval_meas</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
        <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">energy</span><span class="p">))</span>
        <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;E2&quot;</span><span class="p">,</span> <span class="kt">Float64</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">energy</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">MC</span><span class="o">.</span><span class="n">sanity_check</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">nsweeps</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">interval_meas</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ntherm</span> <span class="o">=</span> <span class="n">nsweeps÷10</span>
<span class="n">β</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">ss</span> <span class="o">=</span> <span class="n">MC</span><span class="o">.</span><span class="n">SpinState</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
<span class="n">acc</span> <span class="o">=</span> <span class="n">Meas</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">()</span>
<span class="n">solve!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">β</span><span class="p">,</span> <span class="n">nsweeps</span><span class="p">,</span> <span class="n">ntherm</span><span class="p">,</span> <span class="n">interval_meas</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>

<span class="n">println</span><span class="p">(</span><span class="n">Meas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">))</span>
<span class="n">println</span><span class="p">(</span><span class="n">Meas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;E2&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-78.4
6166.4
</pre></div>
</div>
</div>
</div>
<p>We measure the specific heat with varying the temperature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">nsweeps</span> <span class="o">=</span> <span class="mi">10</span><span class="o">^</span><span class="mi">6</span>
<span class="n">num_spins</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">rng</span> <span class="o">=</span> <span class="kt">MersenneTwister</span><span class="p">(</span><span class="mi">4649</span><span class="p">)</span>
<span class="n">s0</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="kt">Int8</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">num_spins</span><span class="p">)</span>

<span class="n">Ts_mc</span> <span class="o">=</span> <span class="n">range</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">C_mc</span> <span class="o">=</span> <span class="kt">Float64</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">T</span> <span class="kp">in</span> <span class="n">Ts_mc</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">MC</span><span class="o">.</span><span class="n">SpinState</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">Meas</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">()</span>
    <span class="n">solve!</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">T</span><span class="p">,</span> <span class="n">nsweeps</span><span class="p">,</span> <span class="n">ntherm</span><span class="p">,</span> <span class="n">interval_meas</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">Meas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">)</span>
    <span class="n">E2</span> <span class="o">=</span> <span class="n">Meas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;E2&quot;</span><span class="p">)</span>
    <span class="n">push!</span><span class="p">(</span><span class="n">C_mc</span><span class="p">,</span> <span class="p">(</span><span class="n">E2</span><span class="o">-</span><span class="n">E</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">T</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>Let us compare Monte Carlo results with the exact solution <span class="math notranslate nohighlight">\(C/N = \frac{1}{T^2 \cosh^2(1/T)}\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">PyPlot</span>
<span class="n">Ts</span> <span class="o">=</span> <span class="n">range</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">exact_C</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span> <span class="n">cosh</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">T</span><span class="p">))</span><span class="o">^</span><span class="mi">2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">exact_C</span><span class="o">.</span><span class="p">(</span><span class="n">Ts</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;Exact&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Ts_mc</span><span class="p">,</span> <span class="n">C_mc</span> <span class="o">./</span> <span class="n">num_spins</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;MC&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">&quot;o&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">raw</span><span class="s">&quot;</span><span class="si">$T</span><span class="s">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">raw</span><span class="s">&quot;</span><span class="si">$C</span><span class="s">/N$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">nothing</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">nothing</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1dIsing_18_0.png" src="../_images/1dIsing_18_0.png" />
</div>
</div>
<div class="section" id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Permalink to this headline">¶</a></h3>
<p>Measure the magnetic susceptibility and compare the results with the exact solution.</p>
</div>
</div>
<div class="section" id="type-stability-of-accumulator">
<h2>Type stability of Accumulator<a class="headerlink" href="#type-stability-of-accumulator" title="Permalink to this headline">¶</a></h2>
<p>Type safe is an important concept to achieve high performance with Julia (see <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/">officitial document</a>).
Actually, the Accumulator class implemented above is NOT type safe.
Let us see how crtitical it is and how to improve on it.
A convinient way to check the type stability of your code is using &#64;code_warntype macro.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">acc</span> <span class="o">=</span> <span class="n">Meas</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">()</span>
<span class="nd">@code_warntype</span> <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs1&quot;</span><span class="p">,</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables
  #self#
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Cyan">::Core.Compiler.Const(Main.Meas.add!, false)</span>
  acc<span class=" -Color -Color-Cyan">::Main.Meas.Accumulator</span>
  name<span class=" -Color -Color-Cyan">::String</span>
  data<span class=" -Color -Color-Cyan">::Array{Float64,1}</span>

Body<span class=" -Color -Color-Bold">::Any</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 ─ %1  = Base
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>.getproperty(acc, :count)<span class=" -Color -Color-Cyan">::Dict{String,UInt64}</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>│   %2  = Main.Meas.haskey(%1, name)<span class=" -Color -Color-Cyan">::Bool</span>
└──       goto #3 if not %2
2 ─ %4  = Base.getproperty(acc, :count)<span class=" -Color -Color-Cyan">::Dict{String,UInt64}</span>
│   %5  = Base.getindex(%4, name)<span class=" -Color -Color-Cyan">::UInt64</span>
│   %6  = (%5 + 1)<span class=" -Color -Color-Cyan">::UInt64</span>
│   %7  = Base.getproperty(acc, :count)<span class=" -Color -Color-Cyan">::Dict{String,UInt64}</span>
│         Base.setindex!(%7, %6, name)
│   %9  = Base.getproperty(acc, :data)<span class=" -Color -Color-Cyan">::Dict{String,Any}</span>
│   %10 = Base.getindex(%9, name)<span class=" -Color -Color-Bold">::Any</span>
│   %11 = (%10 + data)<span class=" -Color -Color-Bold">::Any</span>
│   %12 = Base.getproperty(acc, :data)<span class=" -Color -Color-Cyan">::Dict{String,Any}</span>
│         Base.setindex!(%12, %11, name)
└──       return %11
3 ─ %15 = Base.getproperty(acc, :count)<span class=" -Color -Color-Cyan">::Dict{String,UInt64}</span>
│         Base.setindex!(%15, 1, name)
│   %17 = Main.Meas.copy(data)<span class=" -Color -Color-Cyan">::Array{Float64,1}</span>
│   %18 = Base.getproperty(acc, :data)<span class=" -Color -Color-Cyan">::Dict{String,Any}</span>
│         Base.setindex!(%18, %17, name)
└──       return %17
</pre></div>
</div>
</div>
</div>
<p>In the above cells, you see many <strong>Any</strong>, which means that the Julia compiler failed to determine the type of some variable.
It is always about <strong>striking a balance between performance and readability</strong>.
Although I usually prefer the latter, it’s your choice.
Let us see how badly the type instability affects the performance!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">obs_val</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="nd">@benchmark</span> <span class="n">Meas</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="s">&quot;obs1&quot;</span><span class="p">,</span> <span class="n">obs_val</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 
  memory estimate:  896 bytes
  allocs estimate:  1
  --------------
  minimum time:     188.622 ns (0.00% GC)
  median time:      192.631 ns (0.00% GC)
  mean time:        225.952 ns (4.53% GC)
  maximum time:     1.914 μs (81.71% GC)
  --------------
  samples:          10000
  evals/sample:     641
</pre></div>
</div>
</div>
</div>
<p>You can see that measuring a Float64 vector with 100 elements takes only 400 ns.
This unlikely affects the overall performance in practical calculation.
However, if you are unhappy with any type instability (and small memory allocation), you could improve on it like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Contribution from Markus Wallerberger at TU Wien</span>
<span class="k">module</span> <span class="n">Meas2</span>

<span class="k">mutable</span> <span class="k">struct</span> <span class="n">Accumulator</span><span class="p">{</span><span class="n">T</span><span class="p">}</span>
    <span class="n">count</span><span class="o">::</span><span class="kt">UInt64</span>
    <span class="n">data</span><span class="o">::</span><span class="n">T</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Constructor</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="n">Accumulator</span><span class="p">(</span><span class="n">initial</span><span class="o">::</span><span class="n">T</span><span class="p">)</span> <span class="n">where</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Accumulator</span><span class="p">(</span><span class="kt">UInt64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">initial</span><span class="p">)</span>


<span class="s">&quot;&quot;&quot;</span>
<span class="s">Add a sample</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="o">::</span><span class="n">Accumulator</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">acc</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">acc</span><span class="o">.</span><span class="n">data</span> <span class="o">.+=</span> <span class="n">data</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">Compuate mean</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span> <span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="o">::</span><span class="n">Accumulator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acc</span><span class="o">.</span><span class="n">data</span><span class="o">/</span><span class="n">acc</span><span class="o">.</span><span class="n">count</span>
<span class="k">end</span>

<span class="k">end</span>

<span class="c"># Perform some tests</span>
<span class="k">let</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">Meas2</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="mi">2</span> <span class="o">.*</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="nd">@assert</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="n">≈</span> <span class="mf">1.5</span> <span class="o">.*</span> <span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">obs_val</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">acc2</span> <span class="o">=</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="n">obs_val</span><span class="p">)</span>
<span class="nd">@code_warntype</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc2</span><span class="p">,</span> <span class="n">obs_val</span><span class="p">)</span>
<span class="nd">@benchmark</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">acc2</span><span class="p">,</span> <span class="n">obs_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Variables
  #self#<span class=" -Color -Color-Cyan">::Core.Compiler.Const(Main.Meas2.add!, false)</span>
  acc<span class=" -Color -Color-Cyan">::Main.Meas2.Accumulator{Array{Float64,1}}</span>
  data<span class=" -Color -Color-Cyan">::Array{Float64,1}</span>

Body<span class=" -Color -Color-Cyan">::Array{Float64,1}</span>
1 ─ %1 = Base.getproperty(acc, :count)<span class=" -Color -Color-Cyan">::UInt64</span>
│   %2 = (%1 + 1)<span class=" -Color -Color-Cyan">::UInt64</span>
│        Base.setproperty!(acc, :count, %2)
│   %4 = Base.getproperty(acc, :data)<span class=" -Color -Color-Cyan">::Array{Float64,1}</span>
│   %5 = Base.broadcasted(Main.Meas2.:+, %4, data)<span class=" -Color -Color-Cyan">::Base.Broadcast.Broadcasted{Base.Broadcast.DefaultArrayStyle{1},Nothing,typeof(+),Tuple{Array{Float64,1},Array{Float64,1}}}</span>
│   %6 = Base.materialize!(%4, %5)<span class=" -Color -Color-Cyan">::Array{Float64,1}</span>
└──      return %6
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     59.429 ns (0.00% GC)
  median time:      60.355 ns (0.00% GC)
  mean time:        67.315 ns (0.00% GC)
  maximum time:     285.265 ns (0.00% GC)
  --------------
  samples:          10000
  evals/sample:     973
</pre></div>
</div>
</div>
</div>
<p>The type instability and memory allocation have been removed at the price that
you need to create an Accumulator object for each observable.
Which one do you like more? It’s up to you.</p>
<p>This improved version can be used with a dictionary as follows.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">meas</span> <span class="o">=</span> <span class="kt">Dict</span><span class="p">{</span><span class="n">String</span><span class="p">,</span><span class="kt">Any</span><span class="p">}()</span>
<span class="n">meas</span><span class="p">[</span><span class="s">&quot;obs1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">Accumulator</span><span class="p">(</span><span class="n">obs_val</span><span class="p">)</span>
<span class="nd">@benchmark</span> <span class="n">Meas2</span><span class="o">.</span><span class="n">add!</span><span class="p">(</span><span class="n">meas</span><span class="p">[</span><span class="s">&quot;obs1&quot;</span><span class="p">],</span> <span class="n">obs_val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 
  memory estimate:  0 bytes
  allocs estimate:  0
  --------------
  minimum time:     87.728 ns (0.00% GC)
  median time:      90.779 ns (0.00% GC)
  mean time:        100.237 ns (0.00% GC)
  maximum time:     393.376 ns (0.00% GC)
  --------------
  samples:          10000
  evals/sample:     956
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.5"
        },
        kernelOptions: {
            kernelName: "julia-1.5",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.5'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="mc.html" title="previous page">概要</a>
    <a class='right-next' id="next-link" href="2dIsing.html" title="next page">2D Ising model</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Hiroshi Shinaoka<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>